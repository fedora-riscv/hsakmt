From f5e043b30085fb9095a96ea9039fc98b87b65ee1 Mon Sep 17 00:00:00 2001
From: Philipp Knechtges <philipp-dev@knechtges.com>
Date: Wed, 25 Nov 2020 20:23:56 +0100
Subject: [PATCH] Fix install targets

---
 CMakeLists.txt         | 15 +++++++--------
 hsakmt-config.cmake.in |  1 +
 2 files changed, 8 insertions(+), 8 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 7bd07ad..b164bf6 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -160,16 +160,14 @@ set ( CMAKE_INSTALL_PREFIX ${CMAKE_INSTALL_PREFIX} CACHE STRING "Default install
 set ( CPACK_PACKAGING_INSTALL_PREFIX "${CMAKE_INSTALL_PREFIX}"  CACHE STRING "Default packaging prefix." )
 set ( CPACK_GENERATOR "DEB;RPM"  CACHE STRING "Default packaging generators." )
 
+set_target_properties(${HSAKMT_TARGET} PROPERTIES PUBLIC_HEADER "${CMAKE_CURRENT_SOURCE_DIR}/include/hsakmt.h;${CMAKE_CURRENT_SOURCE_DIR}/include/hsakmttypes.h;${CMAKE_CURRENT_SOURCE_DIR}/include/linux/kfd_ioctl.h")
+
 # Installs binaries and exports the library usage data to ${HSAKMT_TARGET}Targets
 install ( TARGETS ${HSAKMT_TARGET} EXPORT ${HSAKMT_TARGET}Targets
   ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT binary
-  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT binary )
-
-install ( FILES ${CMAKE_CURRENT_SOURCE_DIR}/LICENSE.md DESTINATION ${CMAKE_INSTALL_DOCDIR} COMPONENT binary )
-
-# Install public headers
-install ( DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/include/ DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
-  COMPONENT devel PATTERN "linux" EXCLUDE )
+  LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR} COMPONENT binary
+  PUBLIC_HEADER DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/libhsakmt
+  INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}/libhsakmt )
 
 # Record our usage data for clients find_package calls.
 install ( EXPORT ${HSAKMT_TARGET}Targets
@@ -192,7 +190,8 @@ include(CMakePackageConfigHelpers)
 configure_package_config_file(${HSAKMT_TARGET}-config.cmake.in
                               ${HSAKMT_TARGET}-config.cmake
                               INSTALL_DESTINATION
-                                  ${CMAKE_INSTALL_LIBDIR}/cmake/${HSAKMT_TARGET} )
+                                  ${CMAKE_INSTALL_LIBDIR}/cmake/${HSAKMT_TARGET}
+			      PATH_VARS INCLUDE_INSTALL_DIR )
 
 write_basic_package_version_file(${HSAKMT_TARGET}-config-version.cmake
                  VERSION ${BUILD_VERSION_STRING}
diff --git a/hsakmt-config.cmake.in b/hsakmt-config.cmake.in
index 9b162da..03c1001 100644
--- a/hsakmt-config.cmake.in
+++ b/hsakmt-config.cmake.in
@@ -10,4 +10,5 @@ include( CMakeFindDependencyMacro )
 # find_dependencies as shown below.
 #find_dependency(Bar, 2.0)
 
+set_and_check(@HSAKMT_TARGET@_INCLUDE_DIR "@PACKAGE_INCLUDE_INSTALL_DIR@/libhsakmt")
 include( "${CMAKE_CURRENT_LIST_DIR}/@HSAKMT_TARGET@Targets.cmake" )
-- 
2.28.0

